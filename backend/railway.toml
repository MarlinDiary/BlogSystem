[build]
builder = "nixpacks"
buildCommand = "npm install"

[deploy]
startCommand = "mkdir -p /data/uploads/covers /data/uploads/avatars /data/uploads/articles && chmod -R 755 /data && ln -sfn /data/uploads /uploads && npm start"
healthcheckPath = "/api/articles"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
numReplicas = 1

[env]
NODE_ENV = "production"
PORT = "3000"
SERVER_URL = "https://blog-production-154c.up.railway.app"
CORS_ORIGINS = "https://blog-production-154c.up.railway.app"

# 持久存储配置
[[volume]]
source = "uploads"
path = "/data"
persistent = true

# 确保上传目录存在并设置软链接
[[init]]
command = "mkdir -p /data/uploads/covers /data/uploads/avatars /data/uploads/articles && chmod -R 755 /data && ln -sfn /data/uploads /uploads" 
